<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datatable API Konfigurasi Tinggi</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Style untuk loader */
        #loader {
            border-top: 4px solid #3b82f6; /* Warna biru Tailwind (blue-500) */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar untuk tabel agar lebih rapi */
        .table-container {
            overflow-x: auto;
            max-height: 70vh; /* Batasi tinggi tabel untuk scroll vertikal */
            overflow-y: auto;
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        } 
        .json-cell-wrapper {
            max-width: 500px; /* Batasan lebar sel JSON */
            overflow-x: scroll; /* Mengaktifkan horizontal scroll di dalam sel */
            overflow-y: scroll; /* Mengaktifkan vertical scroll di dalam sel */
            max-height: 300px; /* Batasan tinggi sel JSON */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-8xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800">Parser API JSON SPPTDLN</h1>
            <p class="text-gray-500 mt-1">Input json file pada json folder formatnya input.json</p>
        </header>

        <!-- Area Kontrol Filter dan Status -->
        <div id="controls-container" class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
            <div id="filter-status" class="text-sm font-medium text-gray-600">
                <span id="record-count">Memuat data...</span>
            </div>
            <button id="reset-filters" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                Reset Filter
            </button>
        </div>

        <!-- Wadah Tabel -->
        <div class="table-container border border-gray-200 rounded-lg shadow-inner mb-8">
            <table id="data-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0 z-10">
                    <!-- Baris Header Kolom akan diisi oleh JS -->
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Baris Data akan diisi oleh JS -->
                    <tr>
                        <td colspan="100%" class="text-center py-12">
                            <div id="loader" class="mx-auto"></div>
                            <p class="mt-4 text-gray-500">Memuat data dari API...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
            <!-- Pesan jika tidak ada data/filter -->
            <div id="no-data-message" class="hidden text-center py-12 text-gray-500 bg-white">
                Tidak ada data yang cocok dengan filter yang diterapkan.
            </div>
        </div>
        
        <!-- Wadah JSON Mentah (Global API Response) -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                JSON Data Mentah (Global API Response)
            </h2>
            <div class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto shadow-xl">
                <pre id="raw-json-output" class="text-sm leading-relaxed"></pre>
            </div>
        </div>

    </div>

    <script>
        // --- KONFIGURASI DATATABLE UTAMA ---
        const config = {
            // URL API Anda. Ganti dengan endpoint API nyata Anda.
            // Contoh ini menggunakan JSONPlaceholder untuk data pengguna (dummy data).
            apiUrl: 'input/input.json',
            
            // Definisikan kolom-kolom yang akan ditampilkan
            // 'key': Key di objek JSON data (misalnya: obj.name)
            // 'label': Label yang akan ditampilkan di header tabel
            // 'renderer': (Opsional) Fungsi untuk memformat nilai
            // 'filterable': (Opsional) Boolean, apakah kolom ini memiliki filter teks
            // 'defaultValue': Nilai yang ditampilkan jika 'key' tidak ditemukan.
            columns: [
                { key: 'register.request.body.mccCode', label: 'mccCode', filterable: true, defaultValue: '!!!', renderer: (value) => `<span class="italic text-gray-600">${value}</span>` },
                { key: 'verify.request.body.paymentMethods', label: 'Payment Methods', filterable: true, defaultValue: '!!!', renderer: (value) => `<span class="italic text-gray-600">${JSON.stringify(value)}</span>` },
                { key: 'register.request.body.mccCode', label: 'mccCode', filterable: true, defaultValue: '!!!', renderer: (value) => `<span class="italic text-gray-600">${value}</span>` },
                // BARU: Kolom untuk menampilkan seluruh objek JSON baris
                { 
                    key: 'register.request.body', // Kunci khusus, tidak ada di data mentah
                    label: 'Register Request', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div  class="json-cell-wrapper text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'register.response.body', // Kunci khusus, tidak ada di data mentah
                    label: 'Register Response', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div  class="json-cell-wrapper text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'verify.request.body', // Kunci khusus, tidak ada di data mentah
                    label: 'verify Request', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="json-cell-wrapper text-xs bg-gray-100 p-1 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'verify.response.body', // Kunci khusus, tidak ada di data mentah
                    label: 'verify Response', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="json-cell-wrapper text-xs bg-gray-100 p-1 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'decline.request.body', // Kunci khusus, tidak ada di data mentah
                    label: 'decline request', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="json-cell-wrapper text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'decline.response', // Kunci khusus, tidak ada di data mentah
                    label: 'decline response', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="json-cell-wrapper text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'chargeback.request.body', // Kunci khusus, tidak ada di data mentah
                    label: 'chargeback request', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
                { 
                    key: 'chargeback.response', // Kunci khusus, tidak ada di data mentah
                    label: 'chargeback response', 
                    filterable: false, 
                    defaultValue: '{}', 
                    renderer: (item) => {
                        // Tampilkan seluruh objek 'item' (data mentah baris) dalam format JSON yang rapi
                        const jsonString = JSON.stringify(item, null, 2);
                        return `
                            <div class="text-xs bg-gray-100 p-2 rounded max-h-40 overflow-y-scroll font-mono text-gray-700 leading-snug shadow-inner">
                                <pre onclick="copyClipboard(this)">${jsonString}</pre>
                            </div>
                        `;
                    }
                },
            ],

            // Fungsi untuk mendapatkan nilai bersarang (misalnya 'address.city') dan menangani ketiadaan
            getNestedValue: (obj, path, defaultValue = '-') => {
                const value = path.split('.').reduce((acc, part) => {
                    return (acc && acc[part] !== undefined && acc[part] !== null) ? acc[part] : undefined;
                }, obj);

                return (value !== undefined) ? value : defaultValue;
            },
        };
        
        // Inisialisasi variabel global
        let originalData = [];
        let filteredData = [];
        let filterValues = {};

        const tableBody = document.getElementById('table-body');
        const dataTable = document.getElementById('data-table');
        const filterStatus = document.getElementById('record-count');
        const noDataMessage = document.getElementById('no-data-message');
        const rawJsonOutput = document.getElementById('raw-json-output');

        async function copyClipboard(element) {
            await navigator.clipboard.writeText(element.innerHTML)
          
            alert("copy to clipboard")  
        }

        // 1. Mengambil data dari API
        async function fetchData() {
            // Tentukan colspan yang benar
            const initialColspan = config.columns.length > 0 ? config.columns.length : 1; 

            tableBody.innerHTML = `<tr><td colspan="${initialColspan}" class="text-center py-12"><div id="loader" class="mx-auto"></div><p class="mt-4 text-gray-500">Memuat data dari API...</p></td></tr>`;
            noDataMessage.classList.add('hidden');
            rawJsonOutput.textContent = 'Memuat JSON...'; 

            try {
                const response = await fetch(config.apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                originalData = await response.json();
                
                // Tampilkan JSON mentah yang diformat rapi
                rawJsonOutput.textContent = JSON.stringify(originalData, null, 2);

                // Inisialisasi data filter dan tampilan awal
                filteredData = originalData;
                initializeFilters();
                renderTable();

            } catch (error) {
                console.error("Gagal mengambil data:", error);
                const colspan = config.columns.length > 0 ? config.columns.length : 1; 
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-6 text-red-600 bg-red-50/50" >⚠️ Gagal memuat data: ${error.message}</td></tr>`;
                filterStatus.textContent = "Gagal memuat data.";
                rawJsonOutput.textContent = `Error: Gagal memuat data dari API. ${error.message}`;
            }
        }

        // 2. Membuat header tabel dan input filter
        function initializeFilters() {
            const thead = dataTable.querySelector('thead');
            thead.innerHTML = '';
            
            // Baris 1: Header Kolom
            let headerRow = '<tr >';
            config.columns.forEach(col => {
                headerRow += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col.label}</th>`;
            });
            headerRow += '</tr>';
            thead.innerHTML += headerRow;

            // Baris 2: Input Filter
            let filterRow = '<tr class="bg-gray-100" id="filter-row >';
            config.columns.forEach(col => {
                filterRow += `<th class="px-6 py-2 border-b border-gray-200">`;
                if (col.filterable) {
                    console.log(col.label + ' is filterable');
                    filterValues[col.key] = ''; // Inisialisasi nilai filter
                    filterRow += `<input type="text" data-key="${col.key}" placeholder="Filter ${col.label}..." class="filter-input w-full p-1 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">`;
                } else {
                    filterRow += ``;
                }
                filterRow += `</th>`;
            });
            filterRow += '</tr>';
            thead.innerHTML += filterRow;

            // Tambahkan event listener ke input filter
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', handleFilterChange);
            });

            // Tambahkan event listener untuk reset filter
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }

        // 3. Menangani perubahan input filter
        function handleFilterChange(event) {
            const key = event.target.dataset.key;
            filterValues[key] = event.target.value.toLowerCase().trim();
            applyFilters();
        }

        // 4. Menerapkan semua filter
        function applyFilters() {
            // Filter data asli (originalData)
            filteredData = originalData.filter(item => {
                // Iterasi melalui setiap filter yang aktif
                for (const key in filterValues) {
                    const filterText = filterValues[key];
                    if (filterText) {
                        // Cari kolom berdasarkan key
                        const column = config.columns.find(c => c.key === key);
                        if (column) {
                            // Gunakan defaultValue (jika ada) saat mengambil nilai untuk filter
                            const rawValue = config.getNestedValue(item, column.key, column.defaultValue || ''); 
                            const itemValue = String(rawValue).toLowerCase();
                            
                            // Jika nilai item tidak mengandung teks filter, item ini dibuang
                            if (!itemValue.includes(filterText)) {
                                return false;
                            }
                        }
                    }
                }
                // Jika lolos semua filter
                return true;
            });

            renderTable();
        }

        // 5. Mereset semua filter
        function resetFilters() {
            // Reset nilai filter dalam memori
            config.columns.forEach(col => {
                if (col.filterable) {
                    filterValues[col.key] = '';
                }
            });

            // Reset input di UI
            document.querySelectorAll('.filter-input').forEach(input => {
                input.value = '';
            });

            // Terapkan filter ulang
            applyFilters();
        }

        // 6. Merender (menggambar) tabel
        function renderTable() {
            tableBody.innerHTML = ''; // Kosongkan body
            
            // Perbarui status rekaman
            const totalRecords = originalData.length;
            const currentRecords = filteredData.length;
            filterStatus.innerHTML = `Menampilkan <span class="font-bold text-gray-800">${currentRecords}</span> dari <span class="font-bold text-gray-800">${totalRecords}</span> rekaman.`;

            if (filteredData.length === 0) {
                noDataMessage.classList.remove('hidden');
                return;
            } else {
                noDataMessage.classList.add('hidden');
            }

            // Buat baris data
            const rowsHtml = filteredData.map((item, index) => {
                const rowClass = index % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                
                let row = `<tr class="${rowClass} transition duration-100">`;

                config.columns.forEach(col => {
                    let value;
                    
                    if (col.key === 'rawJson') {
                        // Kolom spesial: berikan seluruh objek 'item' ke renderer
                        value = item; 
                    } else {
                        // Kolom standar: ambil nilai bersarang
                        value = config.getNestedValue(item, col.key, col.defaultValue || '-');
                    }
                    
                    // Render nilai
                    let renderedValue;
                    if (col.renderer && typeof col.renderer === 'function') {
                        // Gunakan fungsi renderer kustom
                        // Untuk 'rawJson', 'value' adalah seluruh objek item
                        renderedValue = col.renderer(value, item);
                    } else {
                        // Default rendering
                        renderedValue = String(value);
                    }

                    row += `<td class="px-6 py-3 text-sm text-gray-700">${renderedValue}</td>`;
                });

                row += `</tr>`;
                return row;
            }).join('');

            tableBody.innerHTML = rowsHtml;
        }

        // Panggil fungsi utama untuk memulai aplikasi
        fetchData();
    </script>

</body>
</html>